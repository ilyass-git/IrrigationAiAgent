<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me d'Irrigation Intelligent - IA Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 50%, #a5d6a7 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: #2e7d32;
            margin-bottom: 40px;
            padding: 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            font-size: 1.2em;
            color: #4a7c59;
            font-weight: 400;
        }

        .main-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
        }

        .decision-section {
            text-align: center;
            margin-bottom: 50px;
            padding-bottom: 30px;
            border-bottom: 2px solid #f0f0f0;
        }

        .decision-section h2 {
            color: #2e7d32;
            margin-bottom: 30px;
            font-size: 1.8em;
            font-weight: 600;
        }

        .switch-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 12px;
        }

        .switch-label {
            font-size: 1.2em;
            font-weight: 600;
            color: #424242;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 100px;
            height: 50px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #bdbdbd;
            transition: .4s;
            border-radius: 50px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 38px;
            width: 38px;
            left: 6px;
            bottom: 6px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        input:checked + .slider {
            background-color: #66bb6a;
        }

        input:checked + .slider:before {
            transform: translateX(50px);
        }

        .decision-text {
            font-size: 2em;
            font-weight: 600;
            margin: 25px 0;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .decision-irriguer {
            color: #2e7d32;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border: 2px solid #81c784;
        }

        .decision-ne-pas-irriguer {
            color: #c62828;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border: 2px solid #ef9a9a;
        }

        .explication {
            background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f4 100%);
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            font-size: 1.1em;
            line-height: 1.8;
            color: #424242;
            text-align: left;
            border: 1px solid #e0e0e0;
        }

        .explication ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .explication li {
            margin-bottom: 10px;
            padding: 8px 0;
        }

        .explication .check-icon {
            margin-right: 10px;
            color: #66bb6a;
            font-weight: bold;
        }

        .duration-info {
            text-align: center;
            font-size: 1.1em;
            color: #616161;
            margin-top: 15px;
            padding: 12px;
            background-color: #f5f5f5;
            border-radius: 8px;
            font-weight: 500;
        }

        .buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 35px 0;
        }

        button {
            padding: 14px 28px;
            font-size: 1.05em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
            background: linear-gradient(135deg, #66bb6a 0%, #81c784 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #42a5f5 0%, #64b5f6 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 165, 245, 0.3);
            background: linear-gradient(135deg, #64b5f6 0%, #90caf9 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef5350 0%, #e57373 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 83, 80, 0.3);
            background: linear-gradient(135deg, #e57373 0%, #ef9a9a 100%);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 40px;
        }

        .info-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 22px;
            border-radius: 12px;
            border-left: 4px solid #66bb6a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            color: #2e7d32;
            margin-bottom: 12px;
            font-size: 1.1em;
            font-weight: 600;
        }

        .info-card p {
            color: #616161;
            font-size: 1.1em;
            font-weight: 500;
        }

        .timestamp {
            text-align: center;
            color: #9e9e9e;
            font-size: 0.9em;
            margin-top: 20px;
            font-style: italic;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #e0e0e0;
            border-top: 4px solid #66bb6a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scheduler-controls {
            background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f4 100%);
            padding: 25px;
            border-radius: 12px;
            margin-top: 30px;
            border: 1px solid #e0e0e0;
        }

        .scheduler-controls h3 {
            margin-bottom: 18px;
            color: #2e7d32;
            font-weight: 600;
            font-size: 1.3em;
        }

        .scheduler-input {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .scheduler-input label {
            color: #424242;
            font-weight: 500;
        }

        .scheduler-input input {
            padding: 10px 14px;
            border: 1px solid #bdbdbd;
            border-radius: 8px;
            width: 100px;
            font-size: 1em;
            background-color: #ffffff;
            transition: border-color 0.3s ease;
        }

        .scheduler-input input:focus {
            outline: none;
            border-color: #66bb6a;
        }

        .review-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            padding: 30px;
            border-radius: 16px;
            margin-top: 40px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
        }

        .review-card h3 {
            margin-bottom: 20px;
            color: #2e7d32;
            font-weight: 600;
            font-size: 1.4em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #424242;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #bdbdbd;
            border-radius: 8px;
            font-size: 1em;
            background-color: #ffffff;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #66bb6a;
            box-shadow: 0 0 0 3px rgba(102, 187, 106, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .star-picker {
            display: flex;
            gap: 10px;
            font-size: 1.8em;
            margin-top: 8px;
        }

        .star-picker span {
            cursor: pointer;
            color: #e0e0e0;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .star-picker span:hover {
            transform: scale(1.2);
        }

        .star-picker span.selected {
            color: #ffb74d;
        }

        .review-message {
            margin-top: 12px;
            font-size: 0.95em;
            padding: 10px;
            border-radius: 6px;
        }

        .recent-reviews {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid #e0e0e0;
        }

        .recent-reviews h4 {
            margin-bottom: 15px;
            color: #2e7d32;
            font-weight: 600;
            font-size: 1.2em;
        }

        .review-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 10px;
            padding: 16px 18px;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
            transition: box-shadow 0.2s ease;
        }

        .review-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .review-item strong {
            color: #2e7d32;
        }

        .review-stars {
            color: #ffb74d;
            font-size: 1.1em;
        }

        .explication ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .explication li {
            margin-bottom: 8px;
        }

        .explication .check-icon {
            margin-right: 10px;
            color: #66bb6a;
            font-weight: bold;
        }

        /* Section s√©parateurs visuels */
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #e0e0e0 50%, transparent 100%);
            margin: 40px 0;
        }

        /* Layout en deux colonnes */
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        @media (max-width: 968px) {
            .two-columns {
                grid-template-columns: 1fr;
            }
        }

        .column {
            display: flex;
            flex-direction: column;
        }

        .decision-column {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            height: fit-content;
        }

        .review-column {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            height: fit-content;
        }

        .decision-column .decision-section {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .decision-column .decision-section h2 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåæ Syst√®me d'Irrigation Intelligent</h1>
            <p>D√©cision automatis√©e bas√©e sur l'IA et l'analyse de donn√©es</p>
        </div>

        <!-- Section des donn√©es syst√®me en haut -->
        <div class="main-card" style="margin-bottom: 20px;">
            <h2 style="color: #2e7d32; margin-bottom: 25px; font-size: 1.6em; font-weight: 600; text-align: center;">üìä Donn√©es du Syst√®me</h2>
            <div class="info-grid" id="info-grid-top">
                <!-- Les informations seront charg√©es dynamiquement -->
            </div>
        </div>

        <div class="main-card">
            <div class="two-columns">
                <!-- Colonne gauche : D√©cisions -->
                <div class="column decision-column">
                    <div class="decision-section">
                        <h2>üéØ D√©cisions d'Irrigation</h2>
                        
                        <div class="loading" id="loading">
                            <div class="spinner"></div>
                            <p>Analyse en cours...</p>
                        </div>

                        <div id="decision-content">
                            <div class="switch-container">
                                <span class="switch-label">Pompe d'Irrigation</span>
                                <label class="switch">
                                    <input type="checkbox" id="irrigation-switch" disabled>
                                    <span class="slider"></span>
                                </label>
                            </div>

                            <div class="decision-text" id="decision-text">Chargement...</div>
                            
                            <div class="explication" id="explication">
                                En attente d'une d√©cision...
                            </div>

                            <div class="duration-info" id="duration-info">
                                Dur√©e planifi√©e : --
                            </div>

                            <div class="timestamp" id="timestamp"></div>
                        </div>

                        <div class="buttons">
                            <button class="btn-primary" onclick="makeDecision()">
                                üîÑ Lancer la D√©cision
                            </button>
                            <button class="btn-secondary" onclick="refreshStatus()">
                                üîç Actualiser
                            </button>
                            <button class="btn-danger" id="stop-pump-btn" onclick="stopPump()" disabled>
                                ‚èπÔ∏è Arr√™ter la Pompe
                            </button>
                        </div>
                    </div>

                    <div class="scheduler-controls" style="margin-top: 30px;">
                        <h3>‚è∞ Planification Automatique</h3>
                        <div class="scheduler-input">
                            <label>Intervalle (heures):</label>
                            <input type="number" id="interval-hours" value="6" min="1" max="24">
                            <button class="btn-secondary" onclick="startScheduler()">D√©marrer Auto</button>
                            <button class="btn-danger" onclick="stopScheduler()">Arr√™ter Auto</button>
                        </div>
                        <div id="scheduler-status"></div>
                    </div>
                </div>

                <!-- Colonne droite : Avis -->
                <div class="column review-column">
                    <div class="review-card" style="margin-top: 0;">
                        <h3>üßë‚Äçüî¨ Avis de l'expert</h3>
                        <p style="margin-bottom: 15px; color: #666;">
                            D√©cision √©valu√©e : <strong id="review-current-decision">Aucune d√©cision r√©cente</strong>
                        </p>
                        <form id="review-form" onsubmit="submitReview(event)">
                            <div class="form-group">
                                <label for="expert-name">Nom de l'expert</label>
                                <input type="text" id="expert-name" placeholder="Ex: Ing. agronome Karim">
                            </div>
                            <div class="form-group">
                                <label>Note (1 √† 5 √©toiles)</label>
                                <div class="star-picker" id="star-picker">
                                    <span data-value="1" onclick="setReviewStars(1)">‚òÖ</span>
                                    <span data-value="2" onclick="setReviewStars(2)">‚òÖ</span>
                                    <span data-value="3" onclick="setReviewStars(3)">‚òÖ</span>
                                    <span data-value="4" onclick="setReviewStars(4)">‚òÖ</span>
                                    <span data-value="5" onclick="setReviewStars(5)">‚òÖ</span>
                                </div>
                                <input type="hidden" id="review-stars" value="0">
                            </div>
                            <div class="form-group">
                                <label for="review-comment">Commentaire</label>
                                <textarea id="review-comment" placeholder="Expliquez pourquoi la d√©cision est bonne ou √† ajuster..."></textarea>
                            </div>
                            <button type="submit" class="btn-primary">‚úÖ Valider l'avis</button>
                            <div id="review-message" class="review-message"></div>
                        </form>

                        <div class="recent-reviews">
                            <h4>Derniers avis</h4>
                            <div id="recent-reviews-list">
                                <p style="color:#777;">Aucun avis enregistr√© pour le moment.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDecisionId = null;
        let currentDecisionTimestamp = null;
        let currentDecisionLabel = '';
        let selectedStars = 0;

        // Charger la derni√®re d√©cision au chargement de la page
        window.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            updateSchedulerStatus();
            setInterval(updateSchedulerStatus, 30000); // Mettre √† jour toutes les 30 secondes
            loadRecentReviews();
        });

        async function makeDecision() {
            const loading = document.getElementById('loading');
            const decisionContent = document.getElementById('decision-content');
            
            loading.classList.add('active');
            decisionContent.style.opacity = '0.5';

            try {
                const response = await fetch('/api/decision', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    updateUI(result.data);
                    // Rafra√Æchir aussi les donn√©es syst√®me
                    refreshStatus();
                } else {
                    alert('Erreur: ' + result.error);
                }
            } catch (error) {
                alert('Erreur lors de la prise de d√©cision: ' + error);
            } finally {
                loading.classList.remove('active');
                decisionContent.style.opacity = '1';
            }
        }

        async function refreshStatus() {
            try {
                const response = await fetch('/api/decision/last');
                const result = await response.json();
                
                if (result.success && result.data.timestamp) {
                    updateUI(result.data);
                }

                // Charger aussi les informations syst√®me
                const statusResponse = await fetch('/api/status');
                const statusResult = await statusResponse.json();
                
                if (statusResult.success) {
                    updateInfoGrid(statusResult.data);
                    updateInfoGridTop(statusResult.data);
                    renderRecentReviews(statusResult.data.recent_reviews || []);
                }
            } catch (error) {
                console.error('Erreur lors du rafra√Æchissement:', error);
            }
        }

        function updateUI(data) {
            const decision = data.decision;
            const switchElement = document.getElementById('irrigation-switch');
            const decisionText = document.getElementById('decision-text');
            const explication = document.getElementById('explication');
            const timestamp = document.getElementById('timestamp');
            const durationInfo = document.getElementById('duration-info');
            const stopPumpBtn = document.getElementById('stop-pump-btn');

            // Mettre √† jour le switch
            switchElement.checked = (decision === 'IRRIGUER');

            // Mettre √† jour le texte de d√©cision
            decisionText.textContent = decision;
            decisionText.className = 'decision-text ' + 
                (decision === 'IRRIGUER' ? 'decision-irriguer' : 'decision-ne-pas-irriguer');

            // Mettre √† jour l'explication sous forme de liste avec un signe de succ√®s
            const explanationText = data.explication || 'Aucune explication disponible';

            // D√©couper l'explication en phrases (simple d√©coupe sur . ! ?)
            const rawSentences = explanationText
                .split(/[.!?]\s+/)
                .map(s => s.trim())
                .filter(s => s.length > 0);

            if (rawSentences.length === 0) {
                explication.textContent = explanationText;
            } else {
                const itemsHtml = rawSentences
                    .map(sentence => {
                        const cleaned = sentence.replace(/^[-‚Ä¢\s]+/, '');
                        return `<li><span class="check-icon">‚úÖ</span>${cleaned}</li>`;
                    })
                    .join('');
                explication.innerHTML = `<ul>${itemsHtml}</ul>`;
            }

            currentDecisionId = data.id || data.decision_id || null;
            currentDecisionTimestamp = data.timestamp || null;
            currentDecisionLabel = `${decision}${currentDecisionTimestamp ? ' (' + new Date(currentDecisionTimestamp).toLocaleString('fr-FR') + ')' : ''}`;
            updateReviewDecisionLabel();

            // Utiliser l'√©tat r√©el de la pompe si disponible, sinon utiliser les donn√©es de la d√©cision
            const pumpState = data.pump_state || {};
            const isPumpRunning = pumpState.running === true;
            const actualDurationMinutes = isPumpRunning 
                ? Number(pumpState.duration_minutes || 0)
                : Number(data.duration_minutes || (data.metadata && data.metadata.duration_minutes) || 0);
            
            if (durationInfo) {
                if (isPumpRunning && actualDurationMinutes > 0 && pumpState.stop_at) {
                    // Pompe en marche : afficher l'heure d'arr√™t pr√©vue
                    const stopDate = new Date(pumpState.stop_at);
                    durationInfo.textContent = `Dur√©e planifi√©e : ${actualDurationMinutes} min (arr√™t pr√©vu √† ${stopDate.toLocaleTimeString('fr-FR')})`;
                } else if (decision === 'IRRIGUER' && actualDurationMinutes > 0) {
                    // D√©cision d'irriguer mais pompe pas encore d√©marr√©e
                    const startDate = data.timestamp ? new Date(data.timestamp) : new Date();
                    const stopDate = new Date(startDate.getTime() + actualDurationMinutes * 60000);
                    durationInfo.textContent = `Dur√©e planifi√©e : ${actualDurationMinutes} min (arr√™t pr√©vu √† ${stopDate.toLocaleTimeString('fr-FR')})`;
                } else {
                    durationInfo.textContent = 'Dur√©e planifi√©e : 0 min (pompe arr√™t√©e)';
                }
            }
            if (stopPumpBtn) {
                stopPumpBtn.disabled = !isPumpRunning;
            }

            // Mettre √† jour le timestamp
            if (data.timestamp) {
                const date = new Date(data.timestamp);
                timestamp.textContent = 'Derni√®re d√©cision: ' + date.toLocaleString('fr-FR');
            }
        }

        function updateReviewDecisionLabel() {
            const label = document.getElementById('review-current-decision');
            if (currentDecisionId) {
                label.textContent = `${currentDecisionLabel} ‚Äì ID ${currentDecisionId}`;
            } else {
                label.textContent = 'Aucune d√©cision r√©cente';
            }
        }

        function updateInfoGridTop(statusData) {
            const infoGrid = document.getElementById('info-grid-top');
            const weather = statusData.current_weather || {};
            const sensors = statusData.current_sensors || {};
            const pumpState = statusData.pump_state || {};
            const reviewSummary = statusData.review_summary || {};

            // D√©terminer la couleur selon l'humidit√© du sol
            let soilMoistureColor = '#66bb6a';
            let soilMoistureStatus = '‚úì Optimal';
            if (sensors.humidite_sol < 25) {
                soilMoistureColor = '#e57373';
                soilMoistureStatus = '‚ö†Ô∏è Critique';
            } else if (sensors.humidite_sol < 30) {
                soilMoistureColor = '#ffb74d';
                soilMoistureStatus = '‚ö†Ô∏è Sec';
            } else if (sensors.humidite_sol > 70) {
                soilMoistureColor = '#64b5f6';
                soilMoistureStatus = '‚ö†Ô∏è Satur√©';
            }

            const pumpStatusLabel = pumpState.running ? 'En marche' : 'Arr√™t√©e';

            infoGrid.innerHTML = `
                <div class="info-card">
                    <h3>üå°Ô∏è Temp√©rature Air</h3>
                    <p style="font-size: 1.2em; font-weight: 600;">${weather.temperature ? weather.temperature.toFixed(1) + '¬∞C' : 'N/A'}</p>
                </div>
                <div class="info-card">
                    <h3>üí® Humidit√© Air</h3>
                    <p style="font-size: 1.2em; font-weight: 600;">${weather.humidity ? weather.humidity.toFixed(1) + '%' : 'N/A'}</p>
                </div>
                <div class="info-card">
                    <h3>üåßÔ∏è Pluviom√©trie</h3>
                    <p style="font-size: 1.2em; font-weight: 600;">${weather.rainfall ? weather.rainfall.toFixed(1) + 'mm' : '0mm'}</p>
                </div>
                <div class="info-card" style="border-left: 4px solid ${soilMoistureColor};">
                    <h3>üå± Humidit√© du Sol</h3>
                    <p style="font-size: 1.3em; font-weight: bold; color: ${soilMoistureColor};">
                        ${sensors.humidite_sol ? sensors.humidite_sol.toFixed(1) + '%' : 'N/A'}
                    </p>
                    <small>${soilMoistureStatus}</small>
                </div>
                <div class="info-card">
                    <h3>üå°Ô∏è Temp√©rature Sol</h3>
                    <p style="font-size: 1.2em; font-weight: 600;">${sensors.temperature_sol ? sensors.temperature_sol.toFixed(1) + '¬∞C' : 'N/A'}</p>
                </div>
                <div class="info-card">
                    <h3>üíß R√©servoir</h3>
                    <p style="font-size: 1.2em; font-weight: 600;">${sensors.niveau_reservoir ? sensors.niveau_reservoir.toFixed(1) + '%' : 'N/A'}</p>
                </div>
                <div class="info-card">
                    <h3>üí® √âvapotranspiration</h3>
                    <p style="font-size: 1.2em; font-weight: 600;">${sensors.evapotranspiration ? sensors.evapotranspiration.toFixed(1) + ' mm/j' : 'N/A'}</p>
                </div>
                <div class="info-card">
                    <h3>‚≠ê Avis Experts</h3>
                    <p style="font-size: 1.2em; font-weight: 600;">${reviewSummary.total_reviews || 0} avis</p>
                    <small>Note moyenne : ${reviewSummary.average_stars ? reviewSummary.average_stars.toFixed(1) : 'N/A'} / 5</small>
                </div>
                <div class="info-card">
                    <h3>üö∞ Pompe</h3>
                    <p style="font-size: 1.2em; font-weight: 600;">${pumpStatusLabel}</p>
                </div>
            `;
        }

        function updateInfoGrid(statusData) {
            const weather = statusData.current_weather || {};
            const sensors = statusData.current_sensors || {};
            const sensorAlerts = statusData.sensor_alerts || [];
            const pumpState = statusData.pump_state || {};

            // Afficher les alertes si pr√©sentes
            let alertsHtml = '';
            if (sensorAlerts && sensorAlerts.length > 0) {
                alertsHtml = `
                    <div style="background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%); border-left: 4px solid #ffb74d; padding: 18px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <h3 style="color: #f57c00; margin-bottom: 12px; font-weight: 600; font-size: 1.1em;">üö® Alertes des Capteurs</h3>
                        ${sensorAlerts.map(alert => `<p style="color: #e65100; margin: 8px 0; line-height: 1.6;">${alert}</p>`).join('')}
                    </div>
                `;
            }

            updatePumpButtonFromState(pumpState);
        }

        async function startScheduler() {
            const intervalHours = parseInt(document.getElementById('interval-hours').value);
            
            try {
                const response = await fetch('/api/scheduler/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ interval_hours: intervalHours })
                });

                const result = await response.json();
                alert(result.message || 'Scheduler d√©marr√©');
                updateSchedulerStatus();
            } catch (error) {
                alert('Erreur: ' + error);
            }
        }

        async function stopScheduler() {
            try {
                const response = await fetch('/api/scheduler/stop', {
                    method: 'POST'
                });

                const result = await response.json();
                alert(result.message || 'Scheduler arr√™t√©');
                updateSchedulerStatus();
            } catch (error) {
                alert('Erreur: ' + error);
            }
        }

        async function updateSchedulerStatus() {
            try {
                const response = await fetch('/api/scheduler/status');
                const result = await response.json();
                
                const statusDiv = document.getElementById('scheduler-status');
                if (result.success && result.data.jobs.length > 0) {
                    const job = result.data.jobs[0];
                    const nextRun = job.next_run ? new Date(job.next_run).toLocaleString('fr-FR') : 'N/A';
                    statusDiv.innerHTML = `<p><strong>Statut:</strong> Actif | <strong>Prochaine ex√©cution:</strong> ${nextRun}</p>`;
                } else {
                    statusDiv.innerHTML = '<p><strong>Statut:</strong> Inactif</p>';
                }
            } catch (error) {
                console.error('Erreur lors de la mise √† jour du statut:', error);
            }
        }

        function setReviewStars(value) {
            selectedStars = value;
            document.getElementById('review-stars').value = value;
            document.querySelectorAll('#star-picker span').forEach(span => {
                const starValue = parseInt(span.dataset.value, 10);
                span.classList.toggle('selected', starValue <= value);
            });
        }

        function showReviewMessage(message, isError = false) {
            const container = document.getElementById('review-message');
            container.textContent = message;
            if (isError) {
                container.style.color = '#d32f2f';
                container.style.backgroundColor = '#ffebee';
            } else {
                container.style.color = '#2e7d32';
                container.style.backgroundColor = '#e8f5e9';
            }
        }

        async function submitReview(event) {
            event.preventDefault();
            const expertName = document.getElementById('expert-name').value.trim();
            const stars = parseInt(document.getElementById('review-stars').value, 10) || 0;
            const comment = document.getElementById('review-comment').value.trim();

            if (!currentDecisionId) {
                showReviewMessage("Aucune d√©cision √† √©valuer. Lancez une nouvelle d√©cision d'abord.", true);
                return;
            }

            if (stars < 1 || stars > 5) {
                showReviewMessage("Merci de s√©lectionner une note entre 1 et 5 √©toiles.", true);
                return;
            }

            try {
                const response = await fetch('/api/reviews', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        decision_id: currentDecisionId,
                        decision_timestamp: currentDecisionTimestamp,
                        decision: currentDecisionLabel,
                        expert_name: expertName,
                        stars,
                        comment
                    })
                });

                const result = await response.json();
                if (!result.success) {
                    showReviewMessage(result.error || 'Erreur lors de l‚Äôenregistrement de l‚Äôavis.', true);
                    return;
                }

                showReviewMessage("Avis enregistr√© avec succ√®s !");
                document.getElementById('review-form').reset();
                setReviewStars(0);
                loadRecentReviews();
            } catch (error) {
                console.error(error);
                showReviewMessage("Erreur r√©seau lors de l‚Äôenvoi de l‚Äôavis.", true);
            }
        }

        async function loadRecentReviews() {
            try {
                const response = await fetch('/api/reviews/recent');
                const result = await response.json();
                if (result.success) {
                    renderRecentReviews(result.data.reviews || []);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des avis:', error);
            }
        }

        function renderRecentReviews(reviews) {
            const container = document.getElementById('recent-reviews-list');
            if (!reviews || reviews.length === 0) {
                container.innerHTML = '<p style="color:#777;">Aucun avis enregistr√© pour le moment.</p>';
                return;
            }

            const items = reviews.map(review => {
                const stars = Number(review.stars) || 0;
                const starsDisplay = '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(5 - stars);
                const expert = review.expert_name || 'Expert';
                const comment = review.comment || '(Pas de commentaire)';
                const timestamp = review.review_timestamp
                    ? new Date(review.review_timestamp).toLocaleString('fr-FR')
                    : '';
                return `
                    <div class="review-item">
                        <div><strong>${expert}</strong> ‚Äî <span class="review-stars">${starsDisplay}</span></div>
                        <div style="color:#666; font-size:0.9em;">${timestamp}</div>
                        <p style="margin-top:6px; color:#444;">${comment}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = items;
        }

        function updatePumpButtonFromState(pumpState) {
            const stopPumpBtn = document.getElementById('stop-pump-btn');
            const durationInfo = document.getElementById('duration-info');
            if (!stopPumpBtn) return;
            const isRunning = pumpState && pumpState.running;
            stopPumpBtn.disabled = !isRunning;
            if (durationInfo && pumpState) {
                if (isRunning) {
                    const stopText = pumpState.stop_at
                        ? `Arr√™t pr√©vu √† ${new Date(pumpState.stop_at).toLocaleTimeString('fr-FR')}`
                        : '';
                    const duration = pumpState.duration_minutes || '';
                    durationInfo.textContent = `Dur√©e planifi√©e : ${duration || '?'} min ${stopText ? '(' + stopText + ')' : ''}`;
                } else if (pumpState.stop_reason) {
                    const reason = pumpState.stop_reason.replace(/_/g, ' ');
                    durationInfo.textContent = `Pompe arr√™t√©e (${reason})`;
                }
            }
        }

        async function stopPump() {
            const stopPumpBtn = document.getElementById('stop-pump-btn');
            if (stopPumpBtn) stopPumpBtn.disabled = true;
            try {
                const response = await fetch('/api/pump/stop', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    updatePumpButtonFromState(result.data);
                    refreshStatus();
                } else {
                    if (stopPumpBtn) stopPumpBtn.disabled = false;
                    alert(result.error || 'Impossible d‚Äôarr√™ter la pompe.');
                }
            } catch (error) {
                console.error('Erreur lors de l‚Äôarr√™t de la pompe:', error);
                if (stopPumpBtn) stopPumpBtn.disabled = false;
            }
        }
    </script>
</body>
</html>


